<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Schema PDF → .ics</title>
<style>
body { font-family: system-ui, sans-serif; margin: 20px; max-width: 700px; }
h2 { margin-bottom: 0.3em; }
.drop {
  border: 3px dashed #888;
  border-radius: 10px;
  padding: 30px;
  text-align: center;
  cursor: pointer;
}
.drop.drag { border-color: #06c; background: #eef7ff; }
button {
  margin-top: 10px;
  padding: 8px 14px;
  border: none;
  border-radius: 6px;
  background: #06c;
  color: white;
  font-size: 1rem;
  cursor: pointer;
}
button:disabled {
  background: #ccc;
  cursor: not-allowed;
}
pre {
  background: #f6f6f6;
  padding: 10px;
  border-radius: 6px;
  max-height: 250px;
  overflow: auto;
  font-size: 0.85rem;
}
.note { color:#555; font-size:0.9rem; margin-top:6px; }
.success { color: #0a0; }
</style>

<!-- Load local PDF.js build -->
<script src="pdfjs/pdf.min.js"></script>
<script>
  // Tell PDF.js where its worker file is
  pdfjsLib.GlobalWorkerOptions.workerSrc = "pdfjs/pdf.worker.min.js";
</script>
</head>

<body>
<h2>Dra & släpp ditt schema (PDF) → skapa .ics v2</h2>

<div id="drop" class="drop">
  Dra PDF hit eller klicka för att välja fil
  <input id="fileInput" type="file" accept="application/pdf" style="display:none" />
</div>

<button id="downloadBtn" disabled>Hämta .ics</button>
<div id="status" class="note"></div>

<h3>Förhandsvisning</h3>
<pre id="preview">Ingen fil laddad.</pre>

<script>
const drop = document.getElementById('drop');
const fileInput = document.getElementById('fileInput');
const downloadBtn = document.getElementById('downloadBtn');
const preview = document.getElementById('preview');
const status = document.getElementById('status');
let lastIcs = '';

drop.addEventListener('click', () => fileInput.click());
drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('drag'); });
drop.addEventListener('dragleave', () => drop.classList.remove('drag'));
drop.addEventListener('drop', e => { e.preventDefault(); drop.classList.remove('drag'); handleFile(e.dataTransfer.files[0]); });
fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

async function handleFile(file){
  if(!file) return;
  if(!file.name.toLowerCase().endsWith('.pdf')){ alert('Välj en PDF-fil.'); return; }
  status.textContent='Läser PDF...';
  status.className='note';
  try {
    const arrayBuffer = await file.arrayBuffer();
    const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
    const doc = await loadingTask.promise;
    let text='';
    for(let i=1;i<=doc.numPages;i++){
      const page = await doc.getPage(i);
      const content = await page.getTextContent();
      const pageText = content.items.map(it => it.str).join(' ');
      text += '\n' + pageText;
    }
    // Remove multiple spaces but keep structure
    text = text.replace(/\s+/g, ' ');
    const events = parseText(text);
    if(events.length===0){
      status.textContent='Inga rader hittade. Förväntar format: YYYY-MM-DD Dag TTMM TTMM KOD';
      status.className='note';
      preview.textContent=text.slice(0,800)+'…'; // show raw text preview
      downloadBtn.disabled=true;
      return;
    }
    lastIcs = buildIcs(events);
    preview.textContent = events.map(e => `${e.date} ${e.from}-${e.to} ${e.code} ${e.notes || ''}`).join('\n');
    downloadBtn.disabled=false;
    status.textContent = `✓ ${events.length} schemapass hittade och redo att ladda ner!`;
    status.className='note success';
  } catch(err){
    console.error('PDF error:', err);
    status.textContent='Fel vid läsning av PDF: ' + (err.message || err);
    status.className='note';
  }
}

// Match "YYYY-MM-DD DayName TTMM TTMM CODE" with optional notes at end
// More flexible spacing with \s+
function parseText(txt){
  const pattern = /\b(20\d{2}-\d{2}-\d{2})\s+\w+\s+(\d{3,4})\s+(\d{3,4})\s+([A-ZÅÄÖ][A-ZÅÄÖ0-9\s]{1,10})(?:\s+\d+:\d+\s+\d+:\d+)?(?:\s+(.+?)(?=20\d{2}-\d{2}-\d{2}|$))?/gi;
  const events=[];
  let m;
  while((m=pattern.exec(txt))!==null){
    const [_, date, from, to, code, notes] = m;
    events.push({
      date,
      from: fixTime(from),
      to: fixTime(to),
      code: code.trim(),
      notes: notes ? notes.trim() : ''
    });
  }
  return events;
}

function fixTime(s){ return s.padStart(4,'0'); }

function buildIcs(events){
  const lines=[
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//pdf2ics//',
    'CALSCALE:GREGORIAN',
    'METHOD:PUBLISH',
    'X-WR-CALNAME:Arbetsschema',
    'X-WR-TIMEZONE:Europe/Stockholm',
    'BEGIN:VTIMEZONE',
    'TZID:Europe/Stockholm',
    'BEGIN:DAYLIGHT',
    'TZOFFSETFROM:+0100',
    'TZOFFSETTO:+0200',
    'DTSTART:19700329T020000',
    'RRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=-1SU',
    'END:DAYLIGHT',
    'BEGIN:STANDARD',
    'TZOFFSETFROM:+0200',
    'TZOFFSETTO:+0100',
    'DTSTART:19701025T030000',
    'RRULE:FREQ=YEARLY;BYMONTH=10;BYDAY=-1SU',
    'END:STANDARD',
    'END:VTIMEZONE'
  ];
  
  for(const e of events){
    const uid = e.date.replace(/-/g,'') + e.from + e.to + Math.random().toString(36).slice(2,6) + '@pdf2ics';
    lines.push('BEGIN:VEVENT');
    lines.push('UID:' + uid);
    lines.push('DTSTAMP:' + new Date().toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z');
    lines.push('DTSTART;TZID=Europe/Stockholm:' + e.date.replace(/-/g,'') + 'T' + e.from + '00');
    lines.push('DTEND;TZID=Europe/Stockholm:' + e.date.replace(/-/g,'') + 'T' + e.to + '00');
    lines.push('SUMMARY:' + e.code);
    if(e.notes){
      lines.push('DESCRIPTION:' + e.notes);
    }
    lines.push('STATUS:CONFIRMED');
    lines.push('END:VEVENT');
  }
  lines.push('END:VCALENDAR');
  return lines.join('\r\n');
}

downloadBtn.addEventListener('click',()=>{
  const blob=new Blob([lastIcs],{type:'text/calendar;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='schema.ics'; a.click();
  URL.revokeObjectURL(url);
});
</script>
</body>
</html>
