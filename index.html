<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Schema PDF â†’ .ics v5</title>
<style>
* { box-sizing: border-box; }
body { 
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  margin: 0;
  padding: 20px;
  min-height: 100vh;
  background: #f5f1e8;
  display: flex;
  justify-content: center;
  align-items: center;
}
.container {
  background: white;
  border-radius: 20px;
  padding: 40px;
  max-width: 700px;
  width: 100%;
  box-shadow: 0 8px 30px rgba(101, 84, 68, 0.15);
}
h2 { 
  margin: 0 0 10px 0;
  font-size: 1.8rem;
  color: #5a4a3a;
}
.subtitle {
  color: #8b7355;
  font-size: 0.95rem;
  margin-bottom: 30px;
}
.drop {
  border: 3px dashed #c9b99a;
  border-radius: 16px;
  padding: 50px 30px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  background: #faf8f3;
  position: relative;
  overflow: hidden;
}
.drop:hover {
  border-color: #8b7355;
  background: #f5f1e8;
  transform: translateY(-2px);
}
.drop.drag { 
  border-color: #6b8e23;
  background: #f0f4e8;
  transform: scale(1.02);
}
.drop-icon {
  font-size: 3rem;
  margin-bottom: 10px;
}
.drop-text {
  color: #5a4a3a;
  font-size: 1.1rem;
  font-weight: 500;
}
button {
  margin-top: 20px;
  padding: 14px 32px;
  border: none;
  border-radius: 12px;
  background: #6b8e23;
  color: white;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(107, 142, 35, 0.3);
}
button:hover:not(:disabled) {
  transform: translateY(-2px);
  background: #7ba428;
  box-shadow: 0 6px 20px rgba(107, 142, 35, 0.4);
}
button:disabled {
  background: #c9b99a;
  cursor: not-allowed;
  box-shadow: none;
  transform: none;
}
h3 {
  margin: 30px 0 15px 0;
  color: #5a4a3a;
  font-size: 1.3rem;
}
pre {
  background: #faf8f3;
  padding: 20px;
  border-radius: 12px;
  max-height: 300px;
  overflow: auto;
  font-size: 0.9rem;
  border: 1px solid #e8e0d5;
  line-height: 1.6;
  color: #5a4a3a;
}
.note { 
  color: #8b7355;
  font-size: 0.95rem;
  margin-top: 12px;
  padding: 10px;
  border-radius: 8px;
  background: #faf8f3;
}
.success { 
  color: #6b8e23;
  background: #f0f4e8;
  border: 1px solid #d4e4c0;
}
</style>

<!-- Load local PDF.js build -->
<script src="pdfjs/pdf.min.js"></script>
<script>
  // Tell PDF.js where its worker file is
  pdfjsLib.GlobalWorkerOptions.workerSrc = "pdfjs/pdf.worker.min.js";
</script>
</head>

<body>
<div class="container">
<h2>Schema PDF â†’ .ics</h2>
<div class="subtitle">Konvertera ditt arbetsschema till kalenderfil</div>

<div id="drop" class="drop">
  <div class="drop-icon">ðŸ“„</div>
  <div class="drop-text">Dra PDF hit eller klicka fÃ¶r att vÃ¤lja fil</div>
  <input id="fileInput" type="file" accept="application/pdf" style="display:none" />
</div>

<button id="downloadBtn" disabled>ðŸ“¥ HÃ¤mta .ics</button>
<div id="status" class="note"></div>

<h3>FÃ¶rhandsvisning</h3>
<pre id="preview">Ingen fil laddad Ã¤n...</pre>
</div>

<script>
const drop = document.getElementById('drop');
const fileInput = document.getElementById('fileInput');
const downloadBtn = document.getElementById('downloadBtn');
const preview = document.getElementById('preview');
const status = document.getElementById('status');
let lastIcs = '';

drop.addEventListener('click', () => fileInput.click());
drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('drag'); });
drop.addEventListener('dragleave', () => drop.classList.remove('drag'));
drop.addEventListener('drop', e => { e.preventDefault(); drop.classList.remove('drag'); handleFile(e.dataTransfer.files[0]); });
fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

async function handleFile(file){
  if(!file) return;
  if(!file.name.toLowerCase().endsWith('.pdf')){ alert('VÃ¤lj en PDF-fil.'); return; }
  status.textContent='LÃ¤ser PDF...';
  status.className='note';
  try {
    const arrayBuffer = await file.arrayBuffer();
    const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
    const doc = await loadingTask.promise;
    let text='';
    for(let i=1;i<=doc.numPages;i++){
      const page = await doc.getPage(i);
      const content = await page.getTextContent();
      const pageText = content.items.map(it => it.str).join(' ');
      text += '\n' + pageText;
    }
    // Remove multiple spaces but keep structure
    text = text.replace(/\s+/g, ' ');
    const events = parseText(text);
    if(events.length===0){
      status.textContent='Inga rader hittade. FÃ¶rvÃ¤ntar format: YYYY-MM-DD Dag TTMM TTMM KOD';
      status.className='note';
      preview.textContent=text.slice(0,800)+'â€¦'; // show raw text preview
      downloadBtn.disabled=true;
      return;
    }
    lastIcs = buildIcs(events);
    preview.textContent = events.map(e => `${e.date} ${e.from}-${e.to} ${e.code} ${e.notes || ''}`).join('\n');
    downloadBtn.disabled=false;
    status.textContent = `âœ“ ${events.length} schemapass hittade och redo att ladda ner!`;
    status.className='note success';
  } catch(err){
    console.error('PDF error:', err);
    status.textContent='Fel vid lÃ¤sning av PDF: ' + (err.message || err);
    status.className='note';
  }
}

// Match "YYYY-MM-DD DayName TTMM TTMM CODE Rast Tid [Anteckningar]"
// Pattern captures everything after Tid column as potential notes
function parseText(txt){
  const pattern = /\b(20\d{2}-\d{2}-\d{2})\s+(\w+)\s+(\d{3,4})\s+(\d{3,4})\s+([A-ZÃ…Ã„Ã–][A-ZÃ…Ã„Ã–0-9\s]{1,10})\s+\d+:\d+\s+\d+:\d+/gi;
  const events=[];
  let m;
  while((m=pattern.exec(txt))!==null){
    const [fullMatch, date, day, from, to, code] = m;
    // Look for notes after this match, up to the next date or end
    const afterMatch = txt.slice(m.index + fullMatch.length);
    const notesMatch = afterMatch.match(/^\s*([^\d][^0-9]{2,}?)(?=\s+20\d{2}-\d{2}-\d{2}|$)/);
    const notes = notesMatch ? notesMatch[1].trim() : '';
    
    events.push({
      date,
      from: fixTime(from),
      to: fixTime(to),
      code: code.trim(),
      notes: notes && notes.length > 5 && !notes.includes(':') ? notes : ''
    });
  }
  return events;
}

function fixTime(s){ return s.padStart(4,'0'); }

function buildIcs(events){
  const lines=[
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//pdf2ics//',
    'CALSCALE:GREGORIAN',
    'METHOD:PUBLISH',
    'X-WR-CALNAME:Arbetsschema',
    'X-WR-TIMEZONE:Europe/Stockholm',
    'BEGIN:VTIMEZONE',
    'TZID:Europe/Stockholm',
    'BEGIN:DAYLIGHT',
    'TZOFFSETFROM:+0100',
    'TZOFFSETTO:+0200',
    'DTSTART:19700329T020000',
    'RRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=-1SU',
    'END:DAYLIGHT',
    'BEGIN:STANDARD',
    'TZOFFSETFROM:+0200',
    'TZOFFSETTO:+0100',
    'DTSTART:19701025T030000',
    'RRULE:FREQ=YEARLY;BYMONTH=10;BYDAY=-1SU',
    'END:STANDARD',
    'END:VTIMEZONE'
  ];
  
  for(const e of events){
    const uid = e.date.replace(/-/g,'') + e.from + e.to + Math.random().toString(36).slice(2,6) + '@pdf2ics';
    lines.push('BEGIN:VEVENT');
    lines.push('UID:' + uid);
    lines.push('DTSTAMP:' + new Date().toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z');
    lines.push('DTSTART;TZID=Europe/Stockholm:' + e.date.replace(/-/g,'') + 'T' + e.from + '00');
    lines.push('DTEND;TZID=Europe/Stockholm:' + e.date.replace(/-/g,'') + 'T' + e.to + '00');
    const summary = e.notes ? e.code + ', ' + e.notes : e.code;
    lines.push('SUMMARY:' + summary);
    lines.push('STATUS:CONFIRMED');
    lines.push('END:VEVENT');
  }
  lines.push('END:VCALENDAR');
  return lines.join('\r\n');
}

downloadBtn.addEventListener('click',()=>{
  const blob=new Blob([lastIcs],{type:'text/calendar;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='schema.ics'; a.click();
  URL.revokeObjectURL(url);
});
</script>
</body>
</html>
