<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Schema PDF â†’ .ics</title>
<style>
* { box-sizing: border-box; }
body { 
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  margin: 0;
  padding: 20px;
  min-height: 100vh;
  background: #f5f1e8;
  display: flex;
  justify-content: center;
  align-items: center;
}
.container {
  background: white;
  border-radius: 20px;
  padding: 40px;
  max-width: 900px;
  width: 100%;
  box-shadow: 0 8px 30px rgba(101, 84, 68, 0.15);
}
h2 { 
  margin: 0 0 10px 0;
  font-size: 1.8rem;
  color: #5a4a3a;
}
.subtitle {
  color: #8b7355;
  font-size: 0.95rem;
  margin-bottom: 30px;
}
.drop {
  border: 3px dashed #c9b99a;
  border-radius: 16px;
  padding: 50px 30px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  background: #faf8f3;
  position: relative;
  overflow: hidden;
}
.drop:hover {
  border-color: #8b7355;
  background: #f5f1e8;
  transform: translateY(-2px);
}
.drop.drag { 
  border-color: #6b8e23;
  background: #f0f4e8;
  transform: scale(1.02);
}
.drop-icon {
  font-size: 3rem;
  margin-bottom: 10px;
}
.drop-text {
  color: #5a4a3a;
  font-size: 1.1rem;
  font-weight: 500;
}
button {
  margin-top: 20px;
  padding: 14px 32px;
  border: none;
  border-radius: 12px;
  background: #6b8e23;
  color: white;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(107, 142, 35, 0.3);
}
button:hover:not(:disabled) {
  transform: translateY(-2px);
  background: #7ba428;
  box-shadow: 0 6px 20px rgba(107, 142, 35, 0.4);
}
button:disabled {
  background: #c9b99a;
  cursor: not-allowed;
  box-shadow: none;
  transform: none;
}
h3 {
  margin: 30px 0 15px 0;
  color: #5a4a3a;
  font-size: 1.3rem;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
  background: #faf8f3;
  border-radius: 12px;
  overflow: hidden;
}
th {
  background: #6b8e23;
  color: white;
  padding: 10px 8px;
  text-align: left;
  font-weight: 600;
}
td {
  padding: 8px;
  border-bottom: 1px solid #e8e0d5;
  color: #5a4a3a;
}
tr:last-child td {
  border-bottom: none;
}
tr:hover {
  background: #f5f1e8;
}
.table-wrapper {
  max-height: 400px;
  overflow: auto;
  border-radius: 12px;
  border: 1px solid #e8e0d5;
}
.note { 
  color: #8b7355;
  font-size: 0.95rem;
  margin-top: 12px;
  padding: 10px;
  border-radius: 8px;
  background: #faf8f3;
}
.success { 
  color: #6b8e23;
  background: #f0f4e8;
  border: 1px solid #d4e4c0;
}
</style>

<!-- Load local PDF.js build -->
<script src="pdfjs/pdf.min.js"></script>
<script>
  // Tell PDF.js where its worker file is
  pdfjsLib.GlobalWorkerOptions.workerSrc = "pdfjs/pdf.worker.min.js";
</script>
</head>

<body>
<div class="container">
<h2>Schema PDF â†’ .ics</h2>
<div class="subtitle">Konvertera ditt arbetsschema till kalenderfil</div>

<div id="drop" class="drop">
  <div class="drop-icon">ðŸ“„</div>
  <div class="drop-text">Dra PDF hit eller klicka fÃ¶r att vÃ¤lja fil</div>
  <input id="fileInput" type="file" accept="application/pdf" style="display:none" />
</div>

<button id="downloadBtn" disabled>ðŸ“¥ HÃ¤mta .ics</button>
<div id="status" class="note"></div>

<h3>FÃ¶rhandsvisning av tolkat schema</h3>
<div class="table-wrapper">
  <table id="preview">
    <thead>
      <tr>
        <th>Vecka</th>
        <th>Datum</th>
        <th>Dag</th>
        <th>FrÃ¥n</th>
        <th>Till</th>
        <th>Kod</th>
        <th>Rast</th>
        <th>Tid</th>
        <th>Anteckningar</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="9" style="text-align:center;padding:20px;">Ingen fil laddad Ã¤n...</td></tr>
    </tbody>
  </table>
</div>
</div>

<script>
const drop = document.getElementById('drop');
const fileInput = document.getElementById('fileInput');
const downloadBtn = document.getElementById('downloadBtn');
const preview = document.getElementById('preview').querySelector('tbody');
const status = document.getElementById('status');
let parsedRows = [];
let lastIcs = '';

drop.addEventListener('click', () => fileInput.click());
drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('drag'); });
drop.addEventListener('dragleave', () => drop.classList.remove('drag'));
drop.addEventListener('drop', e => { e.preventDefault(); drop.classList.remove('drag'); handleFile(e.dataTransfer.files[0]); });
fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

async function handleFile(file){
  if(!file) return;
  if(!file.name.toLowerCase().endsWith('.pdf')){ alert('VÃ¤lj en PDF-fil.'); return; }
  status.textContent='LÃ¤ser PDF...';
  status.className='note';
  try {
    const arrayBuffer = await file.arrayBuffer();
    const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
    const doc = await loadingTask.promise;
    let text='';
    for(let i=1;i<=doc.numPages;i++){
      const page = await doc.getPage(i);
      const content = await page.getTextContent();
      const pageText = content.items.map(it => it.str).join(' ');
      text += '\n' + pageText;
    }
    
    parsedRows = parseTable(text);
    
    if(parsedRows.length===0){
      status.textContent='Inga rader hittade. Kontrollera PDF-format.';
      status.className='note';
      preview.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:20px;">Ingen data hittades</td></tr>';
      downloadBtn.disabled=true;
      return;
    }
    
    displayTable(parsedRows);
    
    // Filter rows that have date and times for .ics
    const validEvents = parsedRows.filter(r => r.datum && r.frÃ¥n && r.till && r.kod);
    
    if(validEvents.length > 0) {
      lastIcs = buildIcs(validEvents);
      downloadBtn.disabled=false;
      status.textContent = `âœ“ ${validEvents.length} arbetspass redo att exportera!`;
      status.className='note success';
    } else {
      status.textContent = `Tabellen tolkad (${parsedRows.length} rader) men inga giltiga arbetspass hittade`;
      status.className='note';
      downloadBtn.disabled=true;
    }
    
  } catch(err){
    console.error('PDF error:', err);
    status.textContent='Fel vid lÃ¤sning av PDF: ' + (err.message || err);
    status.className='note';
  }
}

function parseTable(txt){
  // Clean up text but preserve some structure
  txt = txt.replace(/\s+/g, ' ').trim();
  
  // Simpler approach: match date + times + code, then rast/tid
  // Week number comes before date sometimes, but we'll make it very optional
  const rowPattern = /(20\d{2}-\d{2}-\d{2})\s+(\w+)\s+(\d{3,4})\s+(\d{3,4})\s+([A-ZÃ…Ã„Ã–][A-ZÃ…Ã„Ã–0-9\s]+?)\s+(\d+:\d+)\s+(\d+:\d+)/gi;
  
  const rows = [];
  let match;
  let currentWeek = '';
  
  // First pass: find all week numbers to map them
  const weekPattern = /\b(\d{1,2})\s+(20\d{2}-\d{2}-\d{2})/g;
  const weekMap = new Map();
  let wm;
  while((wm = weekPattern.exec(txt)) !== null){
    weekMap.set(wm[2], wm[1]); // Map date to week number
  }
  
  while((match = rowPattern.exec(txt)) !== null){
    const [fullMatch, datum, dag, frÃ¥n, till, kod, rast, tid] = match;
    
    // Check if this date has a week number
    const vecka = weekMap.get(datum) || currentWeek;
    if(weekMap.get(datum)) currentWeek = weekMap.get(datum);
    
    // Look for notes after this match
    const afterMatch = txt.slice(match.index + fullMatch.length);
    const notesMatch = afterMatch.match(/^\s*([^\d]{3,}?)(?=\s+20\d{2}-\d{2}-\d{2}|\s+\d{1,2}\s+20\d{2}|$)/);
    let anteckningar = '';
    if(notesMatch && notesMatch[1]){
      const note = notesMatch[1].trim();
      // Filter out likely non-notes (too short, contains only time-like patterns)
      if(note.length > 3 && !note.match(/^\d+:\d+$/)){
        anteckningar = note;
      }
    }
    
    rows.push({
      vecka: vecka,
      datum: datum,
      dag: dag,
      frÃ¥n: fixTime(frÃ¥n),
      till: fixTime(till),
      kod: kod.trim(),
      rast: rast,
      tid: tid,
      anteckningar: anteckningar
    });
  }
  
  return rows;
}

function displayTable(rows){
  preview.innerHTML = '';
  rows.forEach(row => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.vecka}</td>
      <td>${row.datum}</td>
      <td>${row.dag}</td>
      <td>${row.frÃ¥n}</td>
      <td>${row.till}</td>
      <td>${row.kod}</td>
      <td>${row.rast}</td>
      <td>${row.tid}</td>
      <td>${row.anteckningar}</td>
    `;
    preview.appendChild(tr);
  });
}

function fixTime(s){ return s.padStart(4,'0'); }

function buildIcs(events){
  const lines=[
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//pdf2ics//',
    'CALSCALE:GREGORIAN',
    'METHOD:PUBLISH',
    'X-WR-CALNAME:Arbetsschema',
    'X-WR-TIMEZONE:Europe/Stockholm',
    'BEGIN:VTIMEZONE',
    'TZID:Europe/Stockholm',
    'BEGIN:DAYLIGHT',
    'TZOFFSETFROM:+0100',
    'TZOFFSETTO:+0200',
    'DTSTART:19700329T020000',
    'RRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=-1SU',
    'END:DAYLIGHT',
    'BEGIN:STANDARD',
    'TZOFFSETFROM:+0200',
    'TZOFFSETTO:+0100',
    'DTSTART:19701025T030000',
    'RRULE:FREQ=YEARLY;BYMONTH=10;BYDAY=-1SU',
    'END:STANDARD',
    'END:VTIMEZONE'
  ];
  
  for(const e of events){
    const uid = e.datum.replace(/-/g,'') + e.frÃ¥n + e.till + Math.random().toString(36).slice(2,6) + '@pdf2ics';
    const summary = e.anteckningar ? e.kod + ', ' + e.anteckningar : e.kod;
    
    lines.push('BEGIN:VEVENT');
    lines.push('UID:' + uid);
    lines.push('DTSTAMP:' + new Date().toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z');
    lines.push('DTSTART;TZID=Europe/Stockholm:' + e.datum.replace(/-/g,'') + 'T' + e.frÃ¥n + '00');
    lines.push('DTEND;TZID=Europe/Stockholm:' + e.datum.replace(/-/g,'') + 'T' + e.till + '00');
    lines.push('SUMMARY:' + summary);
    lines.push('STATUS:CONFIRMED');
    lines.push('END:VEVENT');
  }
  lines.push('END:VCALENDAR');
  return lines.join('\r\n');
}

downloadBtn.addEventListener('click',()=>{
  const blob=new Blob([lastIcs],{type:'text/calendar;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='schema.ics'; a.click();
  URL.revokeObjectURL(url);
});
</script>
</body>
</html>
